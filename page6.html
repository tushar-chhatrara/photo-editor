<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Your Photo</title>
  <style>
    :root {
      --circle-x: 50%;   /* X center */
      --circle-y: 50%;   /* Y center */
      --circle-r: 20%;   /* Radius (adjusted for square image) */

      --ui: 14px;
      --btn: #111;
      --btnText: #fff;
      --accent: #2d6cdf;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f4f4f4;
      min-height: 100vh;
    }

    .card {
      width: min(100vw, 480px);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      overflow: hidden;
    }

    .stage {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1; /* <-- changed to square */
      background: #eee;
    }

    #poster {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .hotspot {
      position: absolute;
      transform: translate(-50%, -50%);
      display: grid;
      place-items: center;
      cursor: pointer;
    }
    .hotspot::after {
      content: "";
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,.9);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.15) inset;
    }

    .hotspot .cta {
      position: absolute;
      bottom: -2.2rem;
      font-size: var(--ui);
      background: rgba(0,0,0,.7);
      color: #fff;
      padding: .25rem .5rem;
      border-radius: .5rem;
    }

    #maskCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .controls {
      padding: .75rem .9rem 1rem;
      display: grid;
      gap: .6rem;
      font-size: var(--ui);
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: .5rem;
      align-items: center;
    }

    .sliders {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: .5rem;
    }

    input[type="range"] {
      width: 100%;
    }

    button {
      appearance: none;
      border: 0;
      background: var(--btn);
      color: var(--btnText);
      padding: .65rem .9rem;
      border-radius: .6rem;
      font-weight: 600;
      cursor: pointer;
    }

    button.secondary {
      background: #eaeaea;
      color: #111;
    }

    .bar {
      display: flex;
      gap: .5rem;
    }

    .hint {
      color: #666;
      font-size: 12px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="stage" id="stage" aria-label="Template image with a circular photo placeholder">
      <img id="poster" src="Template6.png" alt="Template" />
      <canvas id="maskCanvas" aria-hidden="true"></canvas>
      <div id="hotspot" class="hotspot" role="button" aria-label="Click to add your photo">
        <span class="cta">Tap to add photo</span>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <div>
          <strong>1) Upload</strong>
          <div class="hint">Click the circle above to pick a photo. Then adjust if needed.</div>
        </div>
        <div class="bar">
          <button id="reset" class="secondary" title="Reset">Reset</button>
          <button id="download">Download</button>
        </div>
      </div>

      <div class="sliders" aria-live="polite">
        <label>Zoom
          <input id="zoom" type="range" min="0.05" max="3" step="0.01" value="0" />
        </label>
        <label>Rotate
          <input id="rotate" type="range" min="-180" max="180" step="1" value="0" />
        </label>
        <label>Move X
          <input id="moveX" type="range" min="-1" max="1" step="0.002" value="0" />
        </label>
        <label>Move Y
          <input id="moveY" type="range" min="-1" max="1" step="0.002" value="0" />
        </label>
      </div>

      <div class="hint">Pro tip: On mobile, pinch to zoom and drag inside the circle to reposition.</div>
    </div>
  </div>

  <!-- Hidden file picker -->
  <input id="file" class="sr-only" type="file" accept="image/*" />

  <script>
    // Updated for square image template with centered circle
    const TEMPLATE_SRC = 'Template6.png';

    function pct(n){ return n/100; }

    const url = new URL(location.href);
    const cxPct = parseFloat(url.searchParams.get('cx')) || parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--circle-x'));
    const cyPct = parseFloat(url.searchParams.get('cy')) || parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--circle-y'));
    const crPct = parseFloat(url.searchParams.get('cr')) || parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--circle-r'));

    const poster = document.getElementById('poster');
    const stage  = document.getElementById('stage');
    const hotspot = document.getElementById('hotspot');
    const fileInput = document.getElementById('file');
    const maskCanvas = document.getElementById('maskCanvas');
    const ctx = maskCanvas.getContext('2d');

    const zoom = document.getElementById('zoom');
    const rotate = document.getElementById('rotate');
    const moveX = document.getElementById('moveX');
    const moveY = document.getElementById('moveY');
    const resetBtn = document.getElementById('reset');
    const dlBtn = document.getElementById('download');

    let posterW=0, posterH=0, circle={x:0,y:0,r:0};
    let photo=null;
    let state={ scale:1, rot:0, dx:0, dy:0 };

    poster.src = TEMPLATE_SRC;
    poster.onload = () => {
      const rect = stage.getBoundingClientRect();
      posterW = rect.width;
      posterH = rect.height;
      maskCanvas.width = posterW; maskCanvas.height = posterH;

      circle.x = pct(cxPct) * posterW;
      circle.y = pct(cyPct) * posterH;
      circle.r = pct(crPct) * posterW;

      positionHotspot();
      draw();
    };

    function positionHotspot(){
      hotspot.style.left = circle.x + 'px';
      hotspot.style.top  = circle.y + 'px';
      const d = circle.r*2;
      hotspot.style.width = d + 'px';
      hotspot.style.height = d + 'px';
    }

    hotspot.addEventListener('click', ()=> fileInput.click());

    fileInput.addEventListener('
